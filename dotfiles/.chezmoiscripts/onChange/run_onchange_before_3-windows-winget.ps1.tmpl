# -----------------------------------
# author: @kiliantyler
# title: Windows Winget
# description: Installs Windows Applications via Winget
# -----------------------------------

{{- if eq .chezmoi.os "windows" }}
# Install winget applications
Write-Host "Installing winget applications..." -ForegroundColor Green

{{- range .winget.apps }}
$appId = "{{ . }}"
$found = $false

# Check 1: exact ID match
winget list --id $appId --exact --accept-source-agreements 2>$null | Out-Null
if ($LASTEXITCODE -eq 0) { $found = $true }

# Check 2: parent ID match (e.g. "AgileBits.1Password.Beta" -> "AgileBits.1Password")
if (!$found) {
    $baseName = ($appId -split '\.' | Select-Object -SkipLast 1) -join '.'
    winget list --id $baseName --accept-source-agreements 2>$null | Out-Null
    if ($LASTEXITCODE -eq 0) { $found = $true }
}

# Check 3: name match for apps that register outside winget (e.g. Voicemeeter)
if (!$found) {
    $parts = $appId -split '\.'
    $appName = if ($parts.Length -ge 2) { $parts[1] } else { $parts[-1] }
    winget list --name $appName --accept-source-agreements 2>$null | Out-Null
    if ($LASTEXITCODE -eq 0) { $found = $true }
}

if ($found) {
    Write-Host "$appId already installed, skipping" -ForegroundColor DarkGray
} else {
    Write-Host "Installing $appId..." -ForegroundColor Yellow
    winget install --id $appId --exact --silent --accept-package-agreements --accept-source-agreements
    if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne -1978335189) {
        Write-Host "Failed to install $appId" -ForegroundColor Red
    } else {
        Write-Host "$appId installed successfully" -ForegroundColor Green
    }
}

{{- end }}
Write-Host "Winget installation complete!"
{{- end }}
